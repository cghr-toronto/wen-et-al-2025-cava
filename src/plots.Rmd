---
title: "Plots"
date: "`r format(Sys.time(), '%B %d, %Y')`"
author: "Richard Wen <richard.wen@unityhealth.to>"
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  message=FALSE,
  warning=FALSE
)
options(readr.show_col_types = FALSE)
```

```{r, echo=FALSE, eval=FALSE}
#install.packages("tidyverse")
#install.packages("dplyr")
#install.packages("ggrepel")
#install.packages("patchwork")
```

# Libraries

```{r}
library(tidyverse)
library(dplyr)
library(ggrepel)
library(patchwork)
```

```{r, echo=FALSE}
cat("R Version\n---")
R.version

cat("\nPackage Versions\n---")
cat(paste0("\ntidyverse ", packageVersion("tidyverse")))
```

# Functions

## Data Functions

```{r}

# Order textual age ranges
order_arange <- function(ages) {
    out <- ages %>%
        data.frame %>%
        rename("age_range" = ".") %>%
        separate( # sep into range and unit
            age_range,
            into = c("age_range", "unit"),
            sep = " "
        ) %>%
        separate( # sep into min and max age
            age_range,
            into = c("age_min", "age_max"),
            sep = "-"
        ) %>%
        mutate( # format into correct data types
            age_min = as.integer(age_min),
            age_max = as.integer(age_max),
            unit = str_to_lower(unit) %>%
                factor(., levels = c(
                    "hours",
                    "days",
                    "weeks",
                    "months",
                    "years"
                ))
        ) %>%
        arrange(unit, age_min, age_max) %>% # sort ages
        mutate( # create ordered ages
            age_range = paste0(age_min, "-", age_max, " ", unit)
        ) %>%
        pull(age_range)
    return(out)
}

```

## Metric Functions

Functions for PCCC and CSMF Accuracy.

```{r}

# Calc PCCC
calc_pccc <- function(actual, pred, k = 1, N = NULL, assume_zero = T) {
    
    # Calc N num of causes if not known
    N <- if (is.null(N)) length(unique(na.omit(c(actual, pred)))) else N
    
    # Calc frac of deaths in top k causes
    TP <- actual == pred
    TP[is.na(TP) | is.null(TP)] <- FALSE # for no preds
    C <- sum(TP) / length(actual)
    
    # Calc PCCC
    out <- (C - (k/N)) / (1 - (k/N))
    
    # Scale negative numbers to 0 for easier plotting
    out <- if (assume_zero & out < 0) 0 else out
    return(out)
}

# Calc CSMF accuracy
calc_csmf_acc <- function(actual, pred) {
    
    # Get all unique causes
    causes <- unique(c(actual, pred))
    
    # Get csmfs
    cases <- length(actual)
    csmf_true <- table(actual) / cases
    csmf_pred <- table(pred) / cases
    
    # Correct for missing causes in either actual or pred
    csmf_true <- vapply(
        causes,
        function(x) if (x %in% names(csmf_true)) csmf_true[x] else 0,
        FUN.VALUE = numeric(1)
    )
    csmf_pred <- vapply(
        causes,
        function(x) if (x %in% names(csmf_pred)) csmf_pred[x] else 0,
        FUN.VALUE = numeric(1)
    )
    
    # Calc csmf max error
    csmf_max_error <- 2 * (1 - min(csmf_true))
    
    # Calc csmf acc
    out <- 1 - (sum(abs(csmf_true - csmf_pred)) / csmf_max_error)
    return(out)
}

```

## Plot Functions

Functions for generating plots.

```{r}

# Plot performance of models using lines and points
plot_perf <- function(
        df_long,
        f = calc_pccc,
        group = "cod_name",
        text_scale = 1,
        title = NULL,
        title_size = 10,
        x_title = NULL,
        y_title = NULL,
        text_mid_size = 2 * text_scale,
        text_mid_vjust = 2.5,
        text_end_size = 3 * text_scale,
        text_hjust = 0.1,
        add_min_points = F,
        add_max_points = F,
        mid_points_size = 1.5,
        min_points_size = 2,
        max_points_size,
        x_limits = c(0, 1),
        x_breaks = seq(0, 1, by = 0.1),
        x_expand = expansion(add = 0.2),
        x_title_size = 9 * text_scale,
        y_title_size = 9 * text_scale,
        x_text_size = 8 * text_scale,
        y_text_size = 9 * text_scale,
        sort_group = T,
        ...
    ) {
    
    #  Group data
    df_plot <- df_long %>%
        group_by(.data[[group]], model_name, .drop = F)
    
    # Calc metric
    if (identical(f, calc_pccc)) {
        df_plot <- df_plot %>%
            summarize(
                metric = f(cod, model_cghr10, N = unique(ncod)[1], ...)
            )
    } else {
        df_plot <- df_plot %>%
            summarize(
                metric = f(cod, model_cghr10, ...)
            )
    }
        
    # Add metric value to model name
    df_plot <- df_plot %>%
        mutate( 
            model_label = paste0(model_name, " (", round(metric, 2), ")")
        )
    
    # Add min and max values for each group
    df_ends <- df_plot %>%
        group_by(.data[[group]]) %>%
        summarize(
            min_metric = min(metric),
            max_metric = max(metric),
            model_min = model_name[which.min(metric)],
            model_max = model_name[which.max(metric)]
        ) %>%
        arrange(max_metric)
    
    # Sort group by max model metric
    if (sort_group) {
        df_plot[[group]] <- factor(df_plot[[group]], levels = df_ends[[group]])
        df_ends[[group]] <- factor(df_ends[[group]], levels = df_ends[[group]])
    }
    
    # Filter out the mid models
    df_mids <- df_plot %>%
        left_join(df_ends, by = group) %>%
        filter(model_name != model_max & model_name != model_min)
    
    # Plot metric for each model
    out <- ggplot(df_plot, aes(x = metric, y = .data[[group]])) +
        geom_point( # mid points
            data = df_mids,
            size = mid_points_size
        ) +
        geom_segment( # min max lines
            data = df_ends,
            aes(
                x = min_metric,
                xend = max_metric,
                y = .data[[group]],
                yend = .data[[group]]
            ),
            linewidth = 0.75
        ) +
        geom_text( # min model text
            data = df_ends,
            aes(
                x = min_metric,
                y = .data[[group]],
                label = paste0(model_min, " (", round(min_metric, 2), ")")
            ),
            hjust = 1 + text_hjust,
            vjust = 0.5,
            size = text_end_size
        ) +
        geom_text( # max model text
            data = df_ends,
            aes(
                x = max_metric,
                y = .data[[group]],
                label = paste0(model_max, " (", round(max_metric, 2), ")")
            ),
            hjust = 0 - text_hjust,
            vjust = 0.5,
            size = text_end_size
        ) +
        geom_text_repel( # mid model text
            data = df_mids,
            aes(label = model_label),
            color = "gray60",
            vjust = text_mid_vjust,
            max.overlaps = Inf,
            size = text_mid_size
        ) +
        scale_x_continuous(
            limits = x_limits,
            breaks = x_breaks,
            expand = x_expand
        ) +
        labs(
            title = title,
            x = x_title,
            y = y_title
        ) +
        theme_minimal() +
        theme(
            panel.border = element_rect(
                color = "black",
                fill = NA,
                linewidth = 0.75
            ),
            legend.position = "none",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            plot.title = element_text(size = title_size),
            axis.title.x = element_text(size = x_title_size),
            axis.title.y = element_text(size = y_title_size),
            axis.text.x = element_text(size = x_text_size),
            axis.text.y = element_text(size = y_text_size)
        )
    
    # Add min and max points
    if (add_min_points) {
        out <- out + geom_point( # min points
            data = df_ends,
            aes(x = min_metric),
            size = 2
        )
    }
    if (add_max_points) {
        out <- out + geom_point( # max points
            data = df_ends,
            aes(x = max_metric),
            size = 2
        )
    }
    return(out)
}

# Plot perf of models using trend lines
plot_perf_trend <- function(
        df_long,
        f = calc_pccc,
        group = "age_range",
        text_scale = 1,
        title = NULL,
        x_title = NULL,
        y_title = NULL,
        title_size = 10,
        x_title_size = 9 * text_scale,
        y_title_size = 9 * text_scale,
        x_text_size = 8 * text_scale,
        y_text_size = 9 * text_scale,
        legend_text_size = 9 * text_scale,
        legend_position = "bottom",
        legend_direction = "horizontal",
        legend_spacing = unit(0, "pt")
    ) {
    
    # Calc metric
    df_plot <- df_long %>%
        group_by(.data[[group]], model_name, .drop = F) %>%
        summarize( # calc pccc
            age = paste0(unique(age), collapse = ","),
            metric = f(cod, model_cghr10, N = unique(ncod)[1])
        ) %>%
        mutate( # add pccc to model name
            model_label = paste0(model_name, " (", round(metric, 2), ")")
        )

    # Get custom colors for models
    default_colors <- scales::hue_pal()(length(unique(df_plot$model_name)))
    names(default_colors) <- unique(df_plot$model_name)
    default_colors["Mean"] <- "black"
    
    # Plot trend lines for each model
    out <- ggplot(
        df_plot,
        aes(
            x = .data[[group]],
            y = metric,
            color = model_name,
            group = model_name
        )
    ) +
        geom_line(linewidth = 0.75, alpha = 0.4) + 
        geom_line(
            data = df_plot %>%
                group_by(.data[[group]]) %>%
                summarize(
                    metric = mean(metric),
                    model_name = "Mean"
                ),
            aes(color = model_name),
            se = F,
            linewidth = 1.25
        ) +
        scale_color_manual(values = default_colors) +
        labs(
            title = title,
            x = x_title,
            y = y_title
        ) +
        theme_minimal() +
        theme(
            panel.border = element_rect(
                color = "black",
                fill = NA,
                linewidth = 0.75
            ),
            legend.title = element_blank(),
            legend.text = element_text(size = legend_text_size),
            legend.position = legend_position, 
            legend.direction = legend_direction,
            legend.box.spacing = legend_spacing,
            plot.title = element_text(size = title_size),
            axis.title.x = element_text(size = x_title_size),
            axis.title.y = element_text(size = y_title_size),
            axis.text.x = element_text(size = x_text_size),
            axis.text.y = element_text(size = y_text_size)
        )
    return(out)
    
}

```

# Data

## Raw Data

Load data from `data` folder.

```{r}

# Read preds
df_raw <- read_csv("../data/healsl_rd1to2_cod_v1.csv")

# Display preds
cat("Cases: ", nrow(df_raw), "\n")
print(head(df_raw))

```

## Physician Cases

Filter for cases that were coded by physicians.

```{r}

# Filter for phy cases
df <- df_raw %>%
    filter(!is.na(physician_cghr10) & !is.null(physician_cghr10))

# Preview phy cases
cat("Non-coded Cases: ", nrow(df_raw) - nrow(df))
cat("\nPhysician Coded Cases: ", nrow(df))
df

```

## Combined Models

Create model combinations where if any of the models have the physician code, then set the combined model's output for the case to be the physician code. 

```{r}

# Calc combine preds
df <- df %>%
    mutate(
        "gpt3_insilicova_cghr10" = if_else(
            gpt3_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10,
            physician_cghr10,
            gpt3_cghr10
        ),
        "gpt4_insilicova_cghr10" = if_else(
            gpt4_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10,
            physician_cghr10,
            gpt4_cghr10
        ),
        "gpt3_interva5_cghr10" = if_else(
            gpt3_cghr10 == physician_cghr10 | 
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            gpt3_cghr10
        ),
        "gpt4_interva5_cghr10" = if_else(
            gpt4_cghr10 == physician_cghr10 | 
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            gpt4_cghr10
        ),
        "gpt3_insilicova_interva5_cghr10" = if_else(
            gpt3_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10 |
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            gpt3_cghr10
        ),
        "gpt4_insilicova_interva5_cghr10" = if_else(
            gpt4_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10 |
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            gpt4_cghr10
        )
    )

# Display combine preds
print(head(df %>% select(
    gpt3_insilicova_cghr10,
    gpt4_insilicova_cghr10,
    gpt3_interva5_cghr10,
    gpt4_interva5_cghr10,
    gpt3_insilicova_interva5_cghr10,
    gpt4_insilicova_interva5_cghr10
)))

```

## Inspect Data

Display case counts for raw data and prepared data after combining models and filtering for physician coded cases.

```{r}

cat("\nRaw Data\n--------\n\n")

# Physician info
raw_physicians <- df_raw$physician_cghr10
cat(paste0(
    "Cases (",
    length(unique(na.omit(raw_physicians))), " CODs): ",
    length(raw_physicians),
    "\n"
))

# Physician agreed cases
raw_physicians_agree <- df_raw %>%
    filter(is_agreed == TRUE) %>%
    pull(physician_cghr10)
cat(paste0(
    "Agreed Cases (",
    length(unique(na.omit(raw_physicians_agree))), " CODs): ",
    length(raw_physicians_agree),
    "\n"
))

# Models cases
raw_models <- df_raw %>% select(ends_with("_cghr10"), -physician_cghr10)
for (mcol in colnames(raw_models)) {
    m <- raw_models[[mcol]]
    cat(paste0(
        str_replace_all(mcol, models_format), " Predicted Cases (", 
        length(unique(na.omit(m))), " CODs): ",
        length(m) - sum(is.na(m) | is.null(m)),
        "\n"
    ))
}

cat("\nPrepared Data\n--------------\n")

# Physician cases
physicians <- df$physician_cghr10
cat(paste0(
    "Physician Coded Cases (",
    length(unique(na.omit(physicians))), " CODs): ",
    length(physicians) - sum(is.na(physicians) | is.null(physicians)),
    "\n"
))

# Physician agreed cases
physicians_agree <- df %>%
    filter(is_agreed == TRUE) %>%
    pull(physician_cghr10)
cat(paste0(
    "Physician Agreed Coded Cases (",
    length(unique(na.omit(physicians_agree))), " CODs): ",
    length(physicians_agree) - sum(is.na(physicians_agree) | is.null(physicians_agree)),
    "\n"
))

# Models cases
models <- df %>% select(ends_with("_cghr10"), -physician_cghr10)
for (mcol in colnames(models)) {
    m <- models[[mcol]]
    cat(paste0(
        str_replace_all(mcol, models_format), " Predicted Cases (", 
        length(unique(na.omit(m))), " CODs): ",
        length(m) - sum(is.na(m) | is.null(m)),
        "\n"
    ))
}

# Models agreed cases
models_agree <- df %>%
    filter(is_agreed == TRUE) %>%
    select(ends_with("_cghr10"), -physician_cghr10)
for (mcol in colnames(models_agree)) {
    m <- models_agree[[mcol]]
    cat(paste0(
        str_replace_all(mcol, models_format), " Agreed Predicted Cases (", 
        length(unique(na.omit(m))), " CODs): ",
        length(m) - sum(is.na(m) | is.null(m)),
        "\n"
    ))
}
```

# Preparation

Prepare data for plotting.

## Agreed Cases

Filter for agreed cases only.

```{r}

# Agreed cases only
df <- df %>% filter(is_agreed == TRUE)

```

## Shorten COD Names

Shorten long names into new lines.

```{r}

# Shorten COD names
df <- df %>%
    mutate(across(
        c(
            physician_cghr10,
            gpt3_cghr10,
            gpt4_cghr10,
            insilicova_cghr10,
            interva5_cghr10
        ),
        ~ str_wrap(.x, width = 18)
    ))

```

## Standardize Age Ranges

Standardize age ranges to follow age range and unit format in lowercase.

```{r}

# Standardize ages to age range + unit
df <- df %>%
    mutate(
        age_range = str_to_lower(age_range),
        age_range = str_replace( # neo ages
            age_range,
            " \\(early neonatal\\)| \\(late neonatal\\)",
            ""
        ),
        age_range = case_when( # adult ages
            age == "adult" ~ paste0(age_range, " years"),
            .default = age_range
        )
    )
df$age_range %>% unique

```

## Order Age Ranges

Order age ranges in sequential order.

```{r}

# Get age ranges for adult
ages_adult <- df %>%
    filter(age == "adult") %>%
    pull(age_range) %>%
    unique %>%
    order_arange

# Get age ranges for child
ages_child <- df %>%
    filter(age == "child") %>%
    pull(age_range) %>%
    unique %>%
    order_arange

# Get age ranges for neo
ages_neo <- df %>%
    filter(age == "neo") %>%
    pull(age_range) %>%
    unique %>%
    order_arange

# Order age ranges as factor
df <- df %>%
    mutate(
        age_range = factor(
            age_range,
            levels = c(ages_neo, ages_child, ages_adult)
        )
    )
df$age_range %>% unique

```

## COD Case Count

Count the number and percentage of cases for each CGHR-10 COD.

```{r}

# Count cases per cod
df <- df %>%
    left_join( # count cases and add as column
        df %>%
            group_by(age, physician_cghr10) %>%
            count(name = "physician_cghr10_n") %>%
            group_by(age) %>%
            mutate(
                physician_cghr10_perc = (physician_cghr10_n / sum(physician_cghr10_n)) * 100
            ),
        by = c("age", "physician_cghr10")
    )
df %>% select(rowid, age, physician_cghr10, physician_cghr10_n)

```

## Format Data

Format data into long form with each record consisting of one model.

Also calculates supplementary information for plots and tables.

```{r}

# Number of causes for each age group
ncod_adult <- 19
ncod_child <- 10
ncod_neo <- 7
ncod_all <- ncod_adult + ncod_child + ncod_neo

# Model full name
gpt3_name <- "GPT-3.5"
gpt4_name <- "GPT-4"
isva_name <- "InSilicoVA"
iva5_name <- "InterVA-5"

# Pivot data into long format for calc
df_long <- df %>%
    filter( # remove low count cod
        physician_cghr10_n >= 10
    ) %>%
    pivot_longer( # long format
        ends_with("_cghr10") & !starts_with("physician_"),
        names_to = "model",
        values_to = "model_cghr10"
    ) %>%
    mutate(
        model = str_replace( # remove cghr10
            model,
            "_cghr10",
            ""
        ),
        model_name = str_replace_all(model, "_", " or ") %>% # use full model names
            str_replace(., "gpt3", gpt3_name) %>%
            str_replace(., "gpt4", gpt4_name) %>%
            str_replace(., "insilicova", isva_name) %>%
            str_replace(., "interva5", iva5_name) %>%
            factor(., levels = c(
                gpt4_name,
                gpt3_name,
                isva_name,
                iva5_name
            )),
        age_name = case_when( # use full age name
            age == "adult" ~ "Adult",
            age == "child" ~ "Child",
            age == "neo" ~ "Neonate",
            .default = NA
        ),
        cod = physician_cghr10,
        cod_name = paste0(
            cod,
            "\n(n=", physician_cghr10_n, ", ", round(physician_cghr10_perc), "%)"
        ),
        ncod = case_when( # num of cods for each age group
            age == "adult" ~ ncod_adult,
            age == "child" ~ ncod_child,
            age == "neo" ~ ncod_neo,
            .default = NA
        )
    ) %>%
    filter( # remove combine models
        !str_detect(model_name, " or ")
    )

# Calc num of records for each age
n_all <- df %>% group_by(age) %>% count
n_adult <- n_all %>% filter(age == "adult") %>% pull(n)
n_child <- n_all %>% filter(age == "child") %>% pull(n)
n_neo <- n_all %>% filter(age == "neo") %>% pull(n)

# Calc perc of records for each age
perc_adult <- (n_adult / nrow(df)) * 100
perc_child <- (n_child / nrow(df)) * 100
perc_neo <- (n_neo / nrow(df)) * 100

# Calc num of cods for each age
cod_all <- df_long %>% group_by(age) %>% summarize(n = n_distinct(cod))
cod_adult <- cod_all %>% filter(age == "adult") %>% pull(n)
cod_child <- cod_all %>% filter(age == "child") %>% pull(n)
cod_neo <- cod_all %>% filter(age == "neo") %>% pull(n)

# Preview
df_long

```

# Plots

Generate plots from the predictions.

## PCCC and CSMF

```{r}

# Prep data
df_plot <- df_long %>%
    group_by(model_name) %>%
    summarize(
        pccc = calc_pccc(cod, model_cghr10, N = ncod_all),
        csmf = calc_csmf_acc(cod, model_cghr10)
    ) %>%
    arrange(pccc) %>%
    mutate(
        model_name = factor(model_name, levels = model_name)
    ) %>%
    pivot_longer(
        c(pccc, csmf),
        names_to = "metric",
        values_to = "metric_value"
    ) %>%
    mutate(
        metric = str_to_upper(metric) %>%
            str_replace(., "CSMF", "CSMF Accuracy") %>%
            factor(., levels = rev(c("PCCC", "CSMF Accuracy"))),
        metric_label = paste0(metric, "=", round(metric_value, 2)) %>%
            str_replace(., " Accuracy", "")
    )

# Plot data
fig_pccc_csmf <- ggplot(
    df_plot,
    aes(
        x = metric_value,
        y = model_name,
        fill = metric
    )
) +
    geom_bar(
        stat = "identity",
        position = position_dodge(),
        color = "black",
        width = 0.7
    ) +
    geom_label(
        data = df_plot %>% filter(metric == "PCCC"),
        aes(
            label = metric_label,
            x = 0.085
        ),
        color = "black",
        fill = "white",
        size = 3,
        label.r = unit(0, "pt"),
        vjust = -0.5
    ) +
    geom_label(
        data = df_plot %>% filter(metric == "CSMF Accuracy"),
        aes(
            label = metric_label,
            x = 0.085
        ),
        color = "black",
        fill = "white",
        size = 3,
        label.r = unit(0, "pt"),
        vjust = 1.5
    ) +
    scale_fill_manual(
        values = c("black", "gray"),
        guide = guide_legend(reverse = TRUE)
    ) +
    scale_x_continuous(
        limits = c(0, 1),
        breaks = seq(0, 1, 0.1)
    ) +
    labs(
        title = NULL,
        x = NULL,
        y = NULL
    ) +
    theme_minimal() +
    theme(
        panel.border = element_rect(
            color = "black",
            fill = NA,
            linewidth = 0.75
        ),
        legend.position = c(.875, .5),
        legend.title = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10),
        axis.title.x = element_text(size = 9),
        axis.title.y = element_text(size = 9),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)
    )

# Save plot
ggsave(
    "../manuscript/fig-pccc-csmf.pdf",
    fig_pccc_csmf,
    width = 170,
    height = 100,
    units = "mm",
    dpi = 300
)

# Display plot
fig_pccc_csmf

```

## PCCC By Age

```{r}

# Plot perf for pccc by age groups
fig_pccc <- plot_perf(
    df_long %>%
        mutate(
            age_label = case_when(
                age_name == "Adult"
                    ~ paste0(age_name, "\n12+ Years\n(n=", n_adult, ", ", round(perc_adult), "%)"),
                age_name == "Child"
                    ~ paste0(age_name, "\n28 Days to 11 Years\n(n=", n_child, ", ", round(perc_child), "%)"),
                age_name == "Neonate"
                    ~ paste0(age_name, "\n<28 Days\n(n=", n_neo, ", ", round(perc_neo), "%)"),
                .default = age_name
            ) %>%
                factor(., levels = unique(.) %>% sort %>% rev)
        ),
    calc_pccc,
    group = "age_label",
    x_title = "Partial Chance Corrected Concordance (PCCC, 0=Low, 1=High)",
    text_mid_vjust = 3,
    sort_group = F,
    x_limits = c(0.2, 0.8),
    x_expand = waiver()
)

# Save plot
ggsave(
    "../manuscript/fig-pccc.pdf",
    fig_pccc,
    width = 170,
    height = 60,
    units = "mm",
    dpi = 300
)

# Display plot
fig_pccc

```

## PCCC by Age and COD

### Adult

```{r}

# Plot adult perf for pccc by cod
fig_pccc_cod_adult <- plot_perf(
    df_long %>% filter(age == "adult"),
    calc_pccc,
    group = "cod_name",
    title = paste0("Adult, 12+ Years (n=", n_adult, ")"),
    x_title =  "Partial Chance Corrected Concordance (PCCC, 0=Low, 1=High)",
    text_mid_vjust = -1,
    text_scale = 0.8
)
    
# Save plot
ggsave(
    "../manuscript/fig-pccc-cod-adult.pdf",
    fig_pccc_cod_adult,
    width = 170,
    height = 225,
    units = "mm",
    dpi = 300
)

# Display plot
fig_pccc_cod_adult

```

### Child

```{r}

# Plot child perf for pccc by cod
fig_pccc_cod_child <- plot_perf(
    df_long %>% filter(age == "child"),
    calc_pccc,
    group = "cod_name",
    title = paste0("Child, 28 Days to 11 Years (n=", n_child, ")"),
    x_title =  "Partial Chance Corrected Concordance (PCCC, 0=Low, 1=High)",
    text_scale = 0.95
)

# Save plot
ggsave(
    "../manuscript/fig-pccc-cod-child.pdf",
    fig_pccc_cod_child,
    width = 170,
    height = 150,
    units = "mm",
    dpi = 300
)

# Display plot
fig_pccc_cod_child

```

### Neonate

```{r}

# Plot neo perf for pccc by cod
fig_pccc_cod_neo <- plot_perf(
    df_long %>% filter(age == "neo"),
    calc_pccc,
    group = "cod_name",
    title = paste0("Neonatal, <28 Days (n=", n_neo, ")"),
    x_title =  "Partial Chance Corrected Concordance (PCCC, 0=Low, 1=High)",
    text_mid_vjust = 3,
    text_end_size = 2.25,
    text_scale = 0.95
)

# Save plot
ggsave(
    "../manuscript/fig-pccc-cod-neo.pdf",
    fig_pccc_cod_neo,
    width = 170,
    height = 100,
    units = "mm",
    dpi = 300
)

# Display plot
fig_pccc_cod_neo

```

## PCCC by Age Range

```{r}

# Format levels of age range with breaks
age_levels <- levels(df_long$age_range) %>%
    str_replace(., " ", "\n")

# Plot perf trend over age ranges
fig_pccc_age <- plot_perf_trend(
    df_long %>%
        mutate(
            age_range = str_replace(age_range, " ", "\n") %>%
                factor(., levels = age_levels)
        ),
    title = "Partial Chance Corrected Concordance (PCCC, 0=Low, 1=High)",
    text_scale = 0.9
)

# Save plot
ggsave(
    "../manuscript/fig-pccc-age.pdf",
    fig_pccc_age,
    width = 170,
    height = 100,
    units = "mm",
    dpi = 300
)

# Display plot
fig_pccc_age

```
