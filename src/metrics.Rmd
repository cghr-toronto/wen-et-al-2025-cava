---
title: "Metrics"
date: "`r format(Sys.time(), '%B %d, %Y')`"
author: "Richard Wen <richard.wen@unityhealth.to>"
output: html_notebook
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  message=FALSE,
  warning=FALSE
)
options(readr.show_col_types = FALSE)
```

```{r, echo=FALSE, eval=FALSE}
install.packages("tidyverse")
```

## Libraries

```{r}
library(tidyverse)
```

## Settings

```{r}
models_format <- c(
    "_cghr10" = "",
    "_" = " & ",
    "chatgpt3" = "ChatGPT-3",
    "chatgpt4" = "ChatGPT-4",
    "insilicova" = "InSilicoVA",
    "interva5" = "InterVA-5"
)
stage_format <- c(
    "is_" = "",
    "recon" = "Reconciliation",
    "agreed" = "Agreement",
    "adj" = "Adjudication"
)
```

## Functions

Functions for PCCC and CSMF Accuracy.

```{r}

# Calc PCCC
calc_pccc <- function(actual, pred, k = 1, N = NULL) {
    
    # Calc N num of causes if not known
    N <- if (is.null(N)) length(unique(na.omit(c(actual, pred)))) else N
    
    # Calc frac of deaths in top k causes
    TP <- actual == pred
    TP[is.na(TP) | is.null(TP)] <- FALSE # for no preds
    C <- sum(TP) / length(actual)
    
    # Calc PCCC
    out <- (C - (k/N)) / (1 - (k/N))
    return(out)
}

# Calc CSMF accuracy
calc_csmf_acc <- function(actual, pred) {
    
    # Get all unique causes
    causes <- unique(c(actual, pred))
    
    # Get csmfs
    cases <- length(actual)
    csmf_true <- table(actual) / cases
    csmf_pred <- table(pred) / cases
    
    # Correct for missing causes in either actual or pred
    csmf_true <- vapply(
        causes,
        function(x) if (x %in% names(csmf_true)) csmf_true[x] else 0,
        FUN.VALUE = numeric(1)
    )
    csmf_pred <- vapply(
        causes,
        function(x) if (x %in% names(csmf_pred)) csmf_pred[x] else 0,
        FUN.VALUE = numeric(1)
    )
    
    # Calc csmf max error
    csmf_max_error <- 2 * (1 - min(csmf_true))
    
    # Calc csmf acc
    out <- 1 - (sum(abs(csmf_true - csmf_pred)) / csmf_max_error)
    return(out)
}

# Bulk calc per model
calc_per_model <- function(actual, pred, func, name = "Metric", ...) {
    
    # Prep data in long format grouped by model
    out <- pred %>%
        pivot_longer( # to long format
            everything(),
            names_to = "Model",
            values_to = "prediction"
        ) %>% group_by(Model)
    
    # Calc k if pccc as it is diff for model combos
    if (identical(func, calc_pccc)) {
        out <- out %>%
            summarise(
                !!name := func(
                    actual,
                    prediction,
                    k = str_count(unique(Model), "_") + 1,
                    ...
                )
            )
    } else { # otherwise apply func
        out <- out %>%
            summarise(
                !!name := func(
                    actual,
                    prediction,
                    ...
                )
            )
    }
    
    # Format display and return
    out <- out %>%
        mutate(Model = str_replace_all(Model, models_format)) %>%
        arrange(across({{name}}, desc))
    return(out)
}

# Bulk calc per model based on age and physician coding stage
calc_by_age_stage <- function(df, func, name = "Metric") {
    out <- list()
    
    # Calc overall metric
    out[[name]] <- calc_per_model(
        actual = df %>% pull(physician_cghr10),
        pred = df %>% select(ends_with("_cghr10"), -physician_cghr10),
        func = func
    ) %>% rename(
        {{ name }} := Metric
    )
    
    # Calc metric for va coding stage
    for (stage in c("is_agreed", "is_recon", "is_adj")) {
        
        # Filter data for stage
        df_filter <- df %>% filter(.[[stage]] == TRUE)
        metric_name = paste0(
            name,
            " ",
            str_replace_all(stage, stage_format)
        )
        
        # Calc metric for stage
        out[[metric_name]] <- calc_per_model(
            actual = df_filter %>%
                pull(physician_cghr10),
            pred = df_filter %>%
                select(ends_with("_cghr10"), -physician_cghr10),
            func = func
        ) %>% rename(
             {{ metric_name }} := Metric
        )
    }
    
    # Calc pcc for each age group
    for (age_group in c("adult", "child", "neo")) {
        
        # Filter data for age
        df_filter <- df %>% filter(age == age_group)
        metric_name = paste0(
            name,
            " ",
            str_to_title(age_group)
        )
    
        # Calc metric for age
        out[[metric_name]] <- calc_per_model(
            actual = df_filter %>%
                pull(physician_cghr10),
            pred = df_filter %>%
                select(ends_with("_cghr10"), -physician_cghr10),
            func = func
        ) %>% rename(
             {{ metric_name }} := Metric
        )
        
        # Calc metric for each stage within age group
        for (stage in c("is_agreed", "is_recon", "is_adj")) {
        
            # Filter data for stage within age group
            df_filter <- df %>% filter(
                .[[stage]] == TRUE & age == age_group
            )
            metric_name = paste0(
                name,
                " ",
                str_to_title(age_group),
                " ",
                str_replace_all(stage, stage_format)
            )
            
            # Calc metric for stage within age group
            out[[metric_name]] <- calc_per_model(
                actual = df_filter %>%
                    pull(physician_cghr10),
                pred = df_filter %>%
                    select(ends_with("_cghr10"), -physician_cghr10),
                func = func
            ) %>% rename(
                 {{ metric_name }} := Metric
            )
        }
    }
    
    # Combine all pccc metrics
    out <- reduce(out,
        function(x, y) left_join(x, y, by = "Model")
    ) %>%
        arrange(across({{ name }}, desc))
    return(out)
}
```

## Data

### Raw Data

Load data from `data` folder.

```{r}
raw_df <- read_csv("../data/healsl_rd1to2_cod_v1.csv")
```

```{r, echo=FALSE}
cat("Cases: ", nrow(raw_df), "\n")
print(head(raw_df))
```

### Physician Cases

Filter for cases that were coded by physicians.

```{r}
df <- raw_df %>%
    filter(!is.na(physician_cghr10) & !is.null(physician_cghr10))
```

```{r, echo=FALSE}
cat("Physician Coded Cases: ", nrow(df))
print(head(df))
```

### Combined Models

Create model combinations where if any of the models have the physician code, then set the combined model's output for the case to be the physician code. 

```{r}
df <- df %>%
    mutate(
        "chatgpt3_insilicova_cghr10" = if_else(
            chatgpt3_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt3_cghr10
        ),
        "chatgpt4_insilicova_cghr10" = if_else(
            chatgpt4_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt4_cghr10
        ),
        "chatgpt3_interva5_cghr10" = if_else(
            chatgpt3_cghr10 == physician_cghr10 | 
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt3_cghr10
        ),
        "chatgpt4_interva5_cghr10" = if_else(
            chatgpt4_cghr10 == physician_cghr10 | 
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt4_cghr10
        ),
        "chatgpt3_insilicova_interva5_cghr10" = if_else(
            chatgpt3_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10 |
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt3_cghr10
        ),
        "chatgpt4_insilicova_interva5_cghr10" = if_else(
            chatgpt4_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10 |
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt4_cghr10
        )
    )
```

```{r, echo=FALSE}
print(head(df %>% select(
    chatgpt3_insilicova_cghr10,
    chatgpt4_insilicova_cghr10,
    chatgpt3_interva5_cghr10,
    chatgpt4_interva5_cghr10,
    chatgpt3_insilicova_interva5_cghr10,
    chatgpt4_insilicova_interva5_cghr10
)))
```

### Prepared Data

Display case counts for raw data and prepared data after combining models and filtering for physician coded cases.

```{r}

cat("\nRaw Data\n--------\n\n")

# Physician info
raw_physicians <- raw_df$physician_cghr10
cat(paste0(
    "Cases (",
    length(unique(na.omit(raw_physicians))), " CODs): ",
    length(raw_physicians),
    "\n"
))

# Models cases
raw_models <- raw_df %>% select(ends_with("_cghr10"), -physician_cghr10)
for (mcol in colnames(raw_models)) {
    m <- raw_models[[mcol]]
    cat(paste0(
        str_replace_all(mcol, models_format), " Predicted Cases (", 
        length(unique(na.omit(m))), " CODs): ",
        length(m) - sum(is.na(m) | is.null(m)),
        "\n"
    ))
}

cat("\nPrepared Data\n--------------\n")

# Physician cases
physicians <- df$physician_cghr10
cat(paste0(
    "Physician Coded Cases (",
    length(unique(na.omit(physicians))), " CODs): ",
    length(physicians) - sum(is.na(physicians) | is.null(physicians)),
    "\n"
))

# Models cases
models <- df %>% select(ends_with("_cghr10"), -physician_cghr10)
for (mcol in colnames(models)) {
    m <- models[[mcol]]
    cat(paste0(
        str_replace_all(mcol, models_format), " Predicted Cases (", 
        length(unique(na.omit(m))), " CODs): ",
        length(m) - sum(is.na(m) | is.null(m)),
        "\n"
    ))
}
```

## Methods

Calculate metrics from model outputs compared to physician codes.

### PCCC

Calculate Partial Chance Corrected Concordance (PCCC) to evaluate indivudal performance for each model by age and physician coding stage.

```{r}
pccc <- calc_by_age_stage(df, calc_pccc, "PCCC")
pccc
```

### CSMF Accuracy

Calculate Cause Specific Mortality Fraction (CSMF) Accuracy to evaluate population performance for each model by age and physician coding stage.

```{r}
csmf_acc <- calc_by_age_stage(df, calc_csmf_acc, "CSMF Accuracy")
csmf_acc
```
