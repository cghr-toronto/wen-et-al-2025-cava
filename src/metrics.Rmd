---
title: "Metrics"
date: "`r format(Sys.time(), '%B %d, %Y')`"
author: "Richard Wen <richard.wen@unityhealth.to>"
output: html_notebook
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  message=FALSE,
  warning=FALSE
)
options(readr.show_col_types = FALSE)
```

## Libraries

```{r}
library(tidyverse)
```

## Functions

Functions for PCCC and CSMF Accuracy.

```{r}
calc_pccc <- function(actual, pred, k = 1, N = NULL) {
    
    # Calc N num of causes if not known
    N <- if (is.null(N)) length(unique(na.omit(c(actual, pred)))) else N
    
    # Calc frac of deaths in top k causes
    TP <- actual == pred
    TP[is.na(TP) | is.null(TP)] <- FALSE # for no preds
    C <- sum(TP) / length(actual)
    
    # Calc PCCC
    out <- (C - (k/N)) / (1 - (k/N))
    return(out)
}

calc_csmf_acc <- function(actual, pred) {
    
    # Get all unique causes
    causes <- unique(c(actual, pred))
    
    # Get csmfs
    cases <- length(actual)
    csmf_true <- table(actual) / cases
    csmf_pred <- table(pred) / cases
    
    # Correct for missing causes in either actual or pred
    csmf_true <- vapply(
        causes,
        function(x) if (x %in% names(csmf_true)) csmf_true[x] else 0,
        FUN.VALUE = numeric(1)
    )
    csmf_pred <- vapply(
        causes,
        function(x) if (x %in% names(csmf_pred)) csmf_pred[x] else 0,
        FUN.VALUE = numeric(1)
    )
    
    # Calc csmf max error
    csmf_max_error <- 2 * (1 - min(csmf_true))
    
    # Calc csmf acc
    out <- 1 - (sum(abs(csmf_true - csmf_pred)) / csmf_max_error)
    return(out)
}
```

## Data

### Raw Data

Load data from `data` folder.

```{r}
df <- read_csv("../data/healsl_rd1to2_cod_v1.csv")
```

```{r, echo=FALSE}

# Display num of cases
cat("Number of Cases: ", nrow(df), "\n")

# Get actual and pred
actual <- df$physician_cghr10
pred <- df %>% select(ends_with("_cghr10"), -physician_cghr10)

# Physician info
cat(paste0(
    "Physician Coded Cases (",
    length(unique(na.omit(actual))), " CODs): ",
    length(actual) - sum(is.na(actual) | is.null(actual)),
    "\n"
))

# Models info
for (mcol in colnames(pred)) {
    cat(paste0(
        toupper(str_remove(mcol, "_cghr10")), " Predicted Cases (", 
        length(unique(na.omit(pred[[mcol]]))), " CODs): ",
        length(pred[[mcol]]) - sum(is.na(pred[[mcol]]) | is.null(pred[[mcol]])),
        "\n"
    ))
}

print(head(df))
```

### Physician Cases

Filter for cases that were coded by physicians.

```{r}
df <- df %>%
    filter(!is.na(physician_cghr10) & !is.null(physician_cghr10))
```

```{r, echo=FALSE}
cat("Number of Cases for Metrics: ", nrow(df))
print(head(df))
```

### Combined Models

Create model combinations where if any of the models have the physician code, then set the combined model's output for the case to be the physician code. 

```{r}
df <- df %>%
    mutate(
        "chatgpt3_insilicova_cghr10" = if_else(
            chatgpt3_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt3_cghr10
        ),
        "chatgpt4_insilicova_cghr10" = if_else(
            chatgpt4_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt4_cghr10
        ),
        "chatgpt3_interva5_cghr10" = if_else(
            chatgpt3_cghr10 == physician_cghr10 | 
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt3_cghr10
        ),
        "chatgpt4_interva5_cghr10" = if_else(
            chatgpt4_cghr10 == physician_cghr10 | 
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt4_cghr10
        ),
        "chatgpt3_insilicova_interva5_cghr10" = if_else(
            chatgpt3_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10 |
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt3_cghr10
        ),
        "chatgpt4_insilicova_interva5_cghr10" = if_else(
            chatgpt4_cghr10 == physician_cghr10 | 
                insilicova_cghr10 == physician_cghr10 |
                interva5_cghr10 == physician_cghr10,
            physician_cghr10,
            chatgpt4_cghr10
        )
    )
```

```{r, echo=FALSE}
print(head(df %>% select(
    chatgpt3_insilicova_cghr10,
    chatgpt4_insilicova_cghr10,
    chatgpt3_interva5_cghr10,
    chatgpt4_interva5_cghr10,
    chatgpt3_insilicova_interva5_cghr10,
    chatgpt4_insilicova_interva5_cghr10
)))
```

Separate physician (actual) and model (predicted) CODs.

```{r}
actual <- df$physician_cghr10
pred <- df %>%
    select(ends_with("_cghr10"), -physician_cghr10) %>%
    rename_all(~toupper(str_replace(., "_cghr10", "")))
```

```{r, echo=FALSE}
cat(paste0(
    "Physician Coded Cases (",
    length(unique(na.omit(actual))), " CODs): ",
    length(actual) - sum(is.na(actual) | is.null(actual)),
    "\n"
))
```

```{r, echo=FALSE}
for (mcol in colnames(pred)) {
    cat(paste0(
        mcol, " Predicted Cases (", 
        length(unique(na.omit(pred[[mcol]]))), " CODs): ",
        length(pred[[mcol]]) - sum(is.na(pred[[mcol]]) | is.null(pred[[mcol]])),
        "\n"
    ))
}
```

## Methods

### PCCC

Calculate PCCC to evaluate indivudal performance for each model.

```{r}
pccc <- pred %>%
    pivot_longer(
        everything(),
        names_to = "Model",
        values_to = "prediction"
    ) %>%
    group_by(Model) %>%
    summarise(
        PCCC = calc_pccc(actual, prediction, k = str_count(unique(Model), "_") + 1)
    ) %>%
    mutate(Model = str_replace_all(Model, "_", " & ")) %>%
    arrange(desc(PCCC))
pccc
```

### CSMF Accuracy

Calculate CSMF Accuracy to evaluate population performance for each model.

```{r}
csmf_acc <- pred %>%
    pivot_longer(
        everything(),
        names_to = "Model",
        values_to = "prediction"
    ) %>%
    group_by(Model) %>%
    summarise(
        "CSMF Accuracy" = calc_csmf_acc(actual, prediction)
    ) %>%
    mutate(Model = str_replace_all(Model, "_", " & ")) %>%
    arrange(desc(`CSMF Accuracy`))
csmf_acc
```
