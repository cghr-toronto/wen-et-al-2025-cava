---
title: "Preprocess"
date: "`r format(Sys.time(), '%B %d, %Y')`"
author: "Richard Wen <richard.wen@unityhealth.to>"
output: html_notebook
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  message=FALSE,
  warning=FALSE
)
options(readr.show_col_types = FALSE)
```

```{r, echo=FALSE, eval=FALSE}
install.packages("tidyverse")
```

## Libraries

```{r}
library(tidyverse)
```

```{r, echo=FALSE}
cat("R Version\n---")
R.version

cat("\nPackage Versions\n---")
cat(paste0("\ntidyverse ", packageVersion("tidyverse")))
```

## Data

Load data from `data` and `tmp` folders.

```{r}
# Physicians cols to keep and rename for consistency
phy_cols <- c(
    "rowid",
    "death_age_group",
    "sex_death",
    "p1_icd",
    "p2_icd",
    "p1_recon_icd",
    "p2_recon_icd",
    "adj_icd"
)
phy_rename <- c(
    sex = "sex_death",
    age_range = "death_age_group"
)
phy_adult_cols <- c(
    "rowid",
    "death_age_group",
    "sex_death",
    "p1_icd_cod",
    "p2_icd_cod",
    "p1_recon_icd_cod",
    "p2_recon_icd_cod",
    "adj_icd_cod"
)
phy_adult_rename <- c(
    age_range = "death_age_group",
    sex = "sex_death",
    p1_icd = "p1_icd_cod",
    p2_icd = "p2_icd_cod",
    p1_recon_icd = "p1_recon_icd_cod",
    p2_recon_icd = "p2_recon_icd_cod",
    adj_icd = "adj_icd_cod"
)

# Read data
df <- list(
    wva2016_icd10 = read_csv(
        "../data/wva2016_icd10_v1.csv",
        col_types = cols(wva2016_code = col_double())
    ),
    icd10_cghr10 = read_csv("../data/icd10_cghr10_v1.csv"),
    physician = bind_rows(
        read_csv(
            "../tmp/healsl_rd1_adult_v1.csv",
            col_select = all_of(phy_adult_cols)
        ) %>%
            mutate(round = 1, age = "adult") %>%
            rename(all_of(phy_adult_rename)),
        read_csv(
            "../tmp/healsl_rd2_adult_v1.csv",
            col_select = all_of(phy_adult_cols)
        ) %>%
            mutate(round = 2, age = "adult") %>%
            rename(all_of(phy_adult_rename)),
        read_csv(
            "../tmp/healsl_rd1_child_v1.csv",
            col_select = all_of(phy_cols)
        ) %>%
            mutate(round = 1, age = "child") %>%
            rename(all_of(phy_rename)),
        read_csv(
            "../tmp/healsl_rd2_child_v1.csv",
            col_select = all_of(phy_cols)
        ) %>%
            mutate(round = 2, age = "child") %>%
            rename(all_of(phy_rename)),
        read_csv(
            "../tmp/healsl_rd1_neo_v1.csv",
            col_select = all_of(phy_cols)
        ) %>%
            mutate(round = 1, age = "neo") %>%
            rename(all_of(phy_rename)),
        read_csv(
            "../tmp/healsl_rd2_neo_v1.csv",
            col_select = all_of(phy_cols)
        ) %>%
            mutate(round = 2, age = "neo") %>%
            rename(all_of(phy_rename))
    ),
    model_chatgpt3 = bind_rows(
        read_csv(
            "../tmp/healsl_rd1_rapid_chatgpt3_v1.csv",
            col_select = c("rowid", "round", "api_chat_icd")
        ),
        read_csv(
            "../tmp/healsl_rd2_rapid_chatgpt3_v1.csv",
            col_select = c("rowid", "round", "api_chat_icd")
        )
    ) %>% rename(chatgpt3_icd10 = api_chat_icd),
    model_chatgpt4 = bind_rows(
        read_csv(
            "../tmp/healsl_rd1_rapid_chatgpt4_v1.csv",
            col_select = c("rowid", "round", "api_chat_icd")
        ),
        read_csv(
            "../tmp/healsl_rd2_rapid_chatgpt4_v1.csv",
            col_select = c("rowid", "round", "api_chat_icd")
        )
    ) %>% rename(chatgpt4_icd10 = api_chat_icd),
    model_insilicova = bind_rows(
        read_csv(
            "../tmp/healsl_rd1_rapid_insilicova_v1.csv",
            col_select = c("rowid", "round", "cause1_wva")
        ),
        read_csv(
            "../tmp/healsl_rd2_rapid_insilicova_v1.csv",
            col_select = c("rowid", "round", "cause1_wva")
        )
    ) %>% rename(insilicova_wva2016 = cause1_wva),
    model_interva5 = bind_rows(
        read_csv(
            "../tmp/healsl_rd1_rapid_interva5_v1.csv",
            col_select = c("rowid", "round", "cause1_wva")
        ),
        read_csv(
            "../tmp/healsl_rd2_rapid_interva5_v1.csv",
            col_select = c("rowid", "round", "cause1_wva")
        )
    ) %>% rename(interva5_wva2016 = cause1_wva),
    narrative = bind_rows(
        read_csv(
            "../tmp/healsl_rd1_adult_narrative_v1.csv",
            col_select = c("rowid", "summary")
        ),
        read_csv(
            "../tmp/healsl_rd1_child_narrative_v1.csv",
            col_select = c("rowid", "summary")
        ),
        read_csv(
            "../tmp/healsl_rd1_neo_narrative_v1.csv",
            col_select = c("rowid", "summary")
        ),
        read_csv(
            "../tmp/healsl_rd2_adult_narrative_v1.csv",
            col_select = c("rowid", "summary")
        ),
        read_csv(
            "../tmp/healsl_rd2_child_narrative_v1.csv",
            col_select = c("rowid", "summary")
        ),
        read_csv(
            "../tmp/healsl_rd2_neo_narrative_v1.csv",
            col_select = c("rowid", "summary")
        )
    ),
    who = bind_rows(
        read_csv(
            "../tmp/healsl_rd1_who_adult_v1.csv",
            col_select = c("rowid")
        ),
        read_csv(
            "../tmp/healsl_rd1_who_child_v1.csv",
            col_select = c("rowid")
        ),
        read_csv(
            "../tmp/healsl_rd1_who_neo_v1.csv",
            col_select = c("rowid")
        ),
        read_csv(
            "../tmp/healsl_rd2_who_adult_v1.csv",
            col_select = c("rowid")
        ),
        read_csv(
            "../tmp/healsl_rd2_who_child_v1.csv",
            col_select = c("rowid")
        ),
        read_csv(
            "../tmp/healsl_rd2_who_neo_v1.csv",
            col_select = c("rowid")
        )
    )
)
```

```{r, echo=FALSE}
for (i in names(df)) {
    print(i)
    print(head(df[[i]]))
}
```

## Methods

### Final ICD

Create one column for final physician ICD-10 codes and one column each for physician agreed, reconciled, and adjudicated records based on the following rule:

1. If an adjudicated code exists, use it as the final code
2. If not, use physician 1's reconciled code if it exists
3. Otherwise use physician 1's code

```{r}
df$physician <- df$physician %>%
    mutate(
        physician_icd10 = coalesce(
            adj_icd,
            p1_recon_icd,
            p1_icd
        ),
        is_agreed = if_else(
            is.na(p1_recon_icd) & is.na(p2_recon_icd) & is.na(adj_icd),
            TRUE,
            FALSE
        ),
        is_recon = if_else(
            !is.na(p1_recon_icd) | !is.na(p2_recon_icd),
            TRUE,
            FALSE
        ),
        is_adj = if_else(
            !is.na(adj_icd),
            TRUE,
            FALSE
        )
    ) %>%
    select(
        rowid,
        round,
        age,
        age_range,
        sex,
        p1_icd,
        p2_icd,
        p1_recon_icd,
        p2_recon_icd,
        adj_icd,
        is_agreed,
        is_recon,
        is_adj,
        physician_icd10
    )
head(df$physician)
```

### Combine Outputs

Combine all model and physician predictions with their ages.

```{r}
models <- df[str_starts(names(df), "model_")]
out <- df$physician
for (i in 1:length(models)) {
    out <- out %>%
        left_join(
            models[[i]],
            by = c("rowid" = "rowid", "round" = "round"),
            suffix = c("", "")
        )
}
head(out)
```

### Convert to CGHR-10

Convert ICD-10 and WVA-2016 codes to CGHR-10 codes.

```{r}

# Get wva2016 cols for model preds
wva_cols <- colnames(out)
wva_cols <- wva_cols[!wva_cols %in% c("rowid", "round", "age")]
wva_cols <- wva_cols[str_ends(wva_cols, "_wva2016")]

# Convert wva2016 to icd10 via join
for (wcol in wva_cols) {
    
    # Create new converted col based on model name
    mname <- str_remove(wcol, "_wva2016")
    iname <- paste0(mname, "_icd10")
    
    # Join model wva to mapping wva
    out <- out %>%
    left_join(
        df$wva2016_icd10 %>%
            select(wva2016_code, icd10_code) %>%
            rename_with(~iname, icd10_code),
        by = setNames("wva2016_code", wcol),
        multiple = "first"
    )
}

# Get icd10 cols for model preds
icd_cols <- colnames(out)
icd_cols <- icd_cols[!icd_cols %in% c("rowid", "round", "age")]
icd_cols <- icd_cols[str_ends(icd_cols, "_icd10")]

# Convert icd10 to cghr10 via join
for (icol in icd_cols) {
    
    # Create new converted col based on model name
    mname <- str_remove(icol, "_icd10")
    cname <- paste0(mname, "_cghr10")
    
    # Remove all whitespaces and keep only first icd10 code if multiple
    out[[icol]] <- str_replace_all(out[[icol]], "\\s", "")
    out[[icol]] <- str_extract(out[[icol]], "^[A-Za-z]\\d{2}")
    
    # Join model wva to mapping wva
    out <- out %>%
    left_join(
        df$icd10_cghr10 %>%
            select(icd10_code, cghr10_title, cghr10_age) %>%
            rename_with(~cname, cghr10_title),
        by = setNames(c("icd10_code", "cghr10_age"), c(icol, "age")),
        multiple = "first"
    )
}

head(out)
```

## Checks

### Physician Coded Counts

Check physician coded record counts:

```{r}

# Get icd10 counts
phy_icd10 <- out %>% filter(
    !is.na(physician_icd10) & !is.null(physician_icd10)
)
phy_icd10_agree <- out %>% filter(
     !is.na(physician_icd10) & !is.null(physician_icd10) & is_agreed == TRUE
)

# Get cghr10 counts
phy_cghr10 <- out %>% filter(
    !is.na(physician_cghr10) & !is.null(physician_cghr10)
)
phy_cghr10_agree <- out %>% filter(
     !is.na(physician_cghr10) & !is.null(physician_cghr10) & is_agreed == TRUE
)

# Get age icd10 counts
phy_icd10_adult <- phy_icd10 %>% filter(age == "adult")
phy_icd10_child <- phy_icd10 %>% filter(age == "child")
phy_icd10_neo <- phy_icd10 %>% filter(age == "neo")
phy_icd10_agree_adult <- phy_icd10_agree %>% filter(age == "adult")
phy_icd10_agree_child <- phy_icd10_agree %>% filter(age == "child")
phy_icd10_agree_neo <- phy_icd10_agree %>% filter(age == "neo")

# Get age cghr10 counts
phy_cghr10_adult <- phy_cghr10 %>% filter(age == "adult")
phy_cghr10_child <- phy_cghr10 %>% filter(age == "child")
phy_cghr10_neo <- phy_cghr10 %>% filter(age == "neo")
phy_cghr10_agree_adult <- phy_cghr10_agree %>% filter(age == "adult")
phy_cghr10_agree_child <- phy_cghr10_agree %>% filter(age == "child")
phy_cghr10_agree_neo <- phy_cghr10_agree %>% filter(age == "neo")

# Print results
cat(paste0(
    "Overall\n-------",
    "\nPhysican ICD-10 Coded: ", phy_icd10 %>% nrow,
    "\nPhysician ICD-10 Coded (Agree): ", phy_icd10_agree %>% nrow,
    "\nPhysican CGHR-10 Coded: ", phy_cghr10 %>% nrow,
    "\nPhysician CGHR-10 Coded (Agree): ", phy_cghr10_agree %>% nrow,
    "\n\nAdult\n-----",
    "\nPhysican ICD-10 Coded: ", phy_icd10_adult %>% nrow,
    "\nPhysician ICD-10 Coded (Agree): ", phy_icd10_agree_adult %>% nrow,
    "\nPhysican CGHR-10 Coded: ", phy_cghr10_adult %>% nrow,
    "\nPhysician CGHR-10 Coded (Agree): ", phy_cghr10_agree_adult %>% nrow,
    "\n\nChild\n-----",
    "\nPhysican ICD-10 Coded: ", phy_icd10_child %>% nrow,
    "\nPhysician ICD-10 Coded (Agree): ", phy_icd10_agree_child %>% nrow,
    "\nPhysican CGHR-10 Coded: ", phy_cghr10_child %>% nrow,
    "\nPhysician CGHR-10 Coded (Agree): ", phy_cghr10_agree_child %>% nrow,
    "\n\nNeonatal\n--------",
    "\nPhysican ICD-10 Coded: ", phy_icd10_neo %>% nrow,
    "\nPhysician ICD-10 Coded (Agree): ", phy_icd10_agree_neo %>% nrow,
    "\nPhysican CGHR-10 Coded: ", phy_cghr10_neo %>% nrow,
    "\nPhysician CGHR-10 Coded (Agree): ", phy_cghr10_agree_neo %>% nrow
))
```

### ChatGPT-3.5 Counts

Check ChatGPT-3.5 Counts:

```{r}

# Get phy coded icd10 records only
out_coded <- out %>% filter(
    !is.na(physician_icd10) & !is.null(physician_icd10)
)
out_coded_agree <- out_coded %>% filter(is_agreed == TRUE)

# Get phy coded cghr10 records only
out_coded_cghr10 <- out_coded %>% filter(
    !is.na(physician_cghr10) & !is.null(physician_cghr10)
)
out_coded_cghr10_agree <- out_coded_cghr10 %>% filter(is_agreed == TRUE)

# Get chatgpt3 coded records
out_cgpt3 <- out_coded %>% filter(
    !is.na(chatgpt3_icd10) & !is.null(chatgpt3_icd10)
)
out_cgpt3_agree <- out_coded_agree %>% filter(
    !is.na(chatgpt3_icd10) & !is.null(chatgpt3_icd10)
)
out_cgpt3_cghr10 <- out_coded_cghr10 %>% filter(
    !is.na(chatgpt3_icd10) & !is.null(chatgpt3_icd10)
)
out_cgpt3_cghr10_agree <- out_coded_cghr10_agree %>% filter(
    !is.na(chatgpt3_icd10) & !is.null(chatgpt3_icd10)
)

# Get chatgpt3 coded records converted to cghr10
out_cgpt3_xcghr10 <- out_cgpt3 %>% filter(
    !is.na(chatgpt3_cghr10) & !is.null(chatgpt3_cghr10)
)
out_cgpt3_xcghr10_agree <- out_cgpt3_agree %>% filter(
    !is.na(chatgpt3_cghr10) & !is.null(chatgpt3_cghr10)
)
out_cgpt3_xcghr10_cghr10 <- out_cgpt3_cghr10 %>% filter(
    !is.na(chatgpt3_cghr10) & !is.null(chatgpt3_cghr10)
)
out_cgpt3_xcghr10_cghr10_agree <- out_cgpt3_cghr10_agree %>% filter(
    !is.na(chatgpt3_cghr10) & !is.null(chatgpt3_cghr10)
)

# Print results
cat(paste0(
    "ICD-10 Output\n-------------",
    "\nChatGPT-3.5 ICD-10 Coded (Phy. ICD-10 Coded): ", out_cgpt3 %>% nrow,
    "\nChatGPT-3.5 ICD-10 Coded (Agree, Phy. ICD-10 Coded): ", out_cgpt3_agree %>% nrow,
    "\nChatGPT-3.5 ICD-10 Coded (Phy. CGHR-10 Coded): ", out_cgpt3_cghr10 %>% nrow,
    "\nChatGPT-3.5 ICD-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_cgpt3_cghr10_agree %>% nrow,
    "\n\nAfter Conversion to CGHR-10\n---------------------------",
    "\nChatGPT-3.5 CGHR-10 Coded (Phy. ICD-10 Coded): ", out_cgpt3_xcghr10 %>% nrow,
    "\nChatGPT-3.5 CGHR-10 Coded (Agree, Phy. ICD-10 Coded): ", out_cgpt3_xcghr10_agree %>% nrow,
    "\nChatGPT-3.5 CGHR-10 Coded (Phy. CGHR-10 Coded): ", out_cgpt3_xcghr10_cghr10 %>% nrow,
    "\nChatGPT-3.5 CGHR-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_cgpt3_xcghr10_cghr10_agree %>% nrow
))
```

### ChatGPT-4 Counts

Check ChatGPT-4 Counts:

```{r}

# Get phy coded icd10 records only
out_coded <- out %>% filter(
    !is.na(physician_icd10) & !is.null(physician_icd10)
)
out_coded_agree <- out_coded %>% filter(is_agreed == TRUE)

# Get phy coded cghr10 records only
out_coded_cghr10 <- out_coded %>% filter(
    !is.na(physician_cghr10) & !is.null(physician_cghr10)
)
out_coded_cghr10_agree <- out_coded_cghr10 %>% filter(is_agreed == TRUE)

# Get chatgpt4 coded records
out_cgpt4 <- out_coded %>% filter(
    !is.na(chatgpt4_icd10) & !is.null(chatgpt4_icd10)
)
out_cgpt4_agree <- out_coded_agree %>% filter(
    !is.na(chatgpt4_icd10) & !is.null(chatgpt4_icd10)
)
out_cgpt4_cghr10 <- out_coded_cghr10 %>% filter(
    !is.na(chatgpt4_icd10) & !is.null(chatgpt4_icd10)
)
out_cgpt4_cghr10_agree <- out_coded_cghr10_agree %>% filter(
    !is.na(chatgpt4_icd10) & !is.null(chatgpt4_icd10)
)

# Get chatgpt4 coded records converted to cghr10
out_cgpt4_xcghr10 <- out_cgpt4 %>% filter(
    !is.na(chatgpt4_cghr10) & !is.null(chatgpt4_cghr10)
)
out_cgpt4_xcghr10_agree <- out_cgpt4_agree %>% filter(
    !is.na(chatgpt4_cghr10) & !is.null(chatgpt4_cghr10)
)
out_cgpt4_xcghr10_cghr10 <- out_cgpt4_cghr10 %>% filter(
    !is.na(chatgpt4_cghr10) & !is.null(chatgpt4_cghr10)
)
out_cgpt4_xcghr10_cghr10_agree <- out_cgpt4_cghr10_agree %>% filter(
    !is.na(chatgpt4_cghr10) & !is.null(chatgpt4_cghr10)
)

# Print results
cat(paste0(
    "ICD-10 Output\n-------------",
    "\nChatGPT-4 ICD-10 Coded (Phy. ICD-10 Coded): ", out_cgpt4 %>% nrow,
    "\nChatGPT-4 ICD-10 Coded (Agree, Phy. ICD-10 Coded): ", out_cgpt4_agree %>% nrow,
    "\nChatGPT-4 ICD-10 Coded (Phy. CGHR-10 Coded): ", out_cgpt4_cghr10 %>% nrow,
    "\nChatGPT-4 ICD-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_cgpt4_cghr10_agree %>% nrow,
    "\n\nAfter Conversion to CGHR-10\n---------------------------",
    "\nChatGPT-4 CGHR-10 Coded (Phy. ICD-10 Coded): ", out_cgpt4_xcghr10 %>% nrow,
    "\nChatGPT-4 CGHR-10 Coded (Agree, Phy. ICD-10 Coded): ", out_cgpt4_xcghr10_agree %>% nrow,
    "\nChatGPT-4 CGHR-10 Coded (Phy. CGHR-10 Coded): ", out_cgpt4_xcghr10_cghr10 %>% nrow,
    "\nChatGPT-4 CGHR-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_cgpt4_xcghr10_cghr10_agree %>% nrow
))
```

### InterVA-5 Counts

Check InterVA-5 Counts:

```{r}

# Get who with physician coded records
out_who <- out %>% left_join(
    df$who %>% mutate(rowid_who = rowid),
    by = c("rowid" = "rowid"),
    suffix = c("", "")
) %>% filter(!is.na(rowid_who) & !is.na(physician_icd10))
out_who_agree <- out_who %>% filter(is_agreed == TRUE)

# Get who with physician coded records converted to CGHR-10
out_who_cghr10 <- out %>% filter(!is.na(physician_cghr10))
out_who_cghr10_agree <- out_who_cghr10 %>% filter(is_agreed == TRUE)

# Get interva5 coded records in wva2016
out_iva5 <- out_who %>% filter(
    !is.na(interva5_wva2016) & !is.null(interva5_wva2016)
)
out_iva5_agree <- out_who_agree %>% filter(
    !is.na(interva5_wva2016) & !is.null(interva5_wva2016)
)
out_iva5_cghr10 <- out_who_cghr10 %>% filter(
    !is.na(interva5_wva2016) & !is.null(interva5_wva2016)
)
out_iva5_chr10_agree <- out_who_cghr10_agree %>% filter(
    !is.na(interva5_wva2016) & !is.null(interva5_wva2016)
)

# Get interva5 wva2016 coded records converted to icd10
out_iva5_icd10 <- out_iva5 %>% filter(
    !is.na(interva5_icd10) & !is.null(interva5_icd10)
)
out_iva5_icd10_agree <- out_iva5_agree %>% filter(
    !is.na(interva5_icd10) & !is.null(interva5_icd10)
)
out_iva5_icd10_cghr10 <- out_iva5_cghr10 %>% filter(
    !is.na(interva5_icd10) & !is.null(interva5_icd10)
)
out_iva5_icd10_cghr10_agree <- out_iva5_cghr10_agree %>% filter(
    !is.na(interva5_icd10) & !is.null(interva5_icd10)
)

# Get interva5 icd10 coded records converted to cghr10
out_iva5_xcghr10 <- out_iva5_icd10 %>% filter(
    !is.na(interva5_cghr10) & !is.null(interva5_cghr10)
)
out_iva5_xcghr10_agree <- out_iva5_icd10_agree %>% filter(
    !is.na(interva5_cghr10) & !is.null(interva5_cghr10)
)
out_iva5_xcghr10_cghr10 <- out_iva5_icd10_cghr10 %>% filter(
    !is.na(interva5_cghr10) & !is.null(interva5_cghr10)
)
out_iva5_xcghr10_cghr10_agree <- out_iva5_icd10_cghr10_agree %>% filter(
    !is.na(interva5_cghr10) & !is.null(interva5_cghr10)
)


# Print results
cat(paste0(
    "InterVA-5 WVA-2016 Output\n-------------------------",
    "\nInterVA-5 WVA-2016 Coded (Phy. ICD-10 Coded): ", out_iva5 %>% nrow,
    "\nInterVA-5 WVA-2016 Coded (Agree, Phy. ICD-10 Coded): ", out_iva5_agree %>% nrow,
    "\nInterVA-5 WVA-2016 Coded (Phy. CGHR-10 Coded): ", out_iva5_cghr10 %>% nrow,
    "\nInterVA-5 WVA-2016 Coded (Agree, Phy. CGHR-10 Coded): ", out_iva5_cghr10_agree %>% nrow,
    "\n\nAfter Conversion from WVA-2016 to ICD-10\n----------------------------------------",
    "\nInterVA-5 ICD-10 Coded (Phy. ICD-10 Coded): ", out_iva5_icd10 %>% nrow,
    "\nInterVA-5 ICD-10 Coded (Agree, Phy. ICD-10 Coded): ", out_iva5_icd10_agree %>% nrow,
    "\nInterVA-5 ICD-10 Coded (Phy. CGHR-10 Coded): ", out_iva5_icd10_cghr10 %>% nrow,
    "\nInterVA-5 ICD-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_iva5_icd10_cghr10_agree %>% nrow,
    "\n\nAfter Conversion from ICD-10 to CGHR-10\n---------------------------------------",
    "\nInterVA-5 CGHR-10 Coded (Phy. ICD-10 Coded): ", out_iva5_xcghr10 %>% nrow,
    "\nInterVA-5 CGHR-10 Coded (Agree, Phy. ICD-10 Coded): ", out_iva5_xcghr10_agree %>% nrow,
    "\nInterVA-5 CGHR-10 Coded (Phy. CGHR-10 Coded): ", out_iva5_xcghr10_cghr10 %>% nrow,
    "\nInterVA-5 CGHR-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_iva5_xcghr10_cghr10_agree %>% nrow
))
```

### InSilicoVA Counts

Check InSilicoVA Counts:

```{r}

# Get who with physician coded records
out_who <- out %>% left_join(
    df$who %>% mutate(rowid_who = rowid),
    by = c("rowid" = "rowid"),
    suffix = c("", "")
) %>% filter(!is.na(rowid_who) & !is.na(physician_icd10))
out_who_agree <- out_who %>% filter(is_agreed == TRUE)

# Get who with physician coded records converted to CGHR-10
out_who_cghr10 <- out %>% filter(!is.na(physician_cghr10))
out_who_cghr10_agree <- out_who_cghr10 %>% filter(is_agreed == TRUE)

# Get insilicova coded records in wva2016
out_isva <- out_who %>% filter(
    !is.na(insilicova_wva2016) & !is.null(insilicova_wva2016)
)
out_isva_agree <- out_who_agree %>% filter(
    !is.na(insilicova_wva2016) & !is.null(insilicova_wva2016)
)
out_isva_cghr10 <- out_who_cghr10 %>% filter(
    !is.na(insilicova_wva2016) & !is.null(insilicova_wva2016)
)
out_isva_chr10_agree <- out_who_cghr10_agree %>% filter(
    !is.na(insilicova_wva2016) & !is.null(insilicova_wva2016)
)

# Get insilicova wva2016 coded records converted to icd10
out_isva_icd10 <- out_isva %>% filter(
    !is.na(insilicova_icd10) & !is.null(insilicova_icd10)
)
out_isva_icd10_agree <- out_isva_agree %>% filter(
    !is.na(insilicova_icd10) & !is.null(insilicova_icd10)
)
out_isva_icd10_cghr10 <- out_isva_cghr10 %>% filter(
    !is.na(insilicova_icd10) & !is.null(insilicova_icd10)
)
out_isva_icd10_cghr10_agree <- out_isva_cghr10_agree %>% filter(
    !is.na(insilicova_icd10) & !is.null(insilicova_icd10)
)

# Get insilicova icd10 coded records converted to cghr10
out_isva_xcghr10 <- out_isva_icd10 %>% filter(
    !is.na(insilicova_cghr10) & !is.null(insilicova_cghr10)
)
out_isva_xcghr10_agree <- out_isva_icd10_agree %>% filter(
    !is.na(insilicova_cghr10) & !is.null(insilicova_cghr10)
)
out_isva_xcghr10_cghr10 <- out_isva_icd10_cghr10 %>% filter(
    !is.na(insilicova_cghr10) & !is.null(insilicova_cghr10)
)
out_isva_xcghr10_cghr10_agree <- out_isva_icd10_cghr10_agree %>% filter(
    !is.na(insilicova_cghr10) & !is.null(insilicova_cghr10)
)


# Print results
cat(paste0(
    "InSilicoVA WVA-2016 Output\n-------------------------",
    "\nInSilicoVA WVA-2016 Coded (Phy. ICD-10 Coded): ", out_isva %>% nrow,
    "\nInSilicoVA WVA-2016 Coded (Agree, Phy. ICD-10 Coded): ", out_isva_agree %>% nrow,
    "\nInSilicoVA WVA-2016 Coded (Phy. CGHR-10 Coded): ", out_isva_cghr10 %>% nrow,
    "\nInSilicoVA WVA-2016 Coded (Agree, Phy. CGHR-10 Coded): ", out_isva_cghr10_agree %>% nrow,
    "\n\nAfter Conversion from WVA-2016 to ICD-10\n----------------------------------------",
    "\nInSilicoVA ICD-10 Coded (Phy. ICD-10 Coded): ", out_isva_icd10 %>% nrow,
    "\nInSilicoVA ICD-10 Coded (Agree, Phy. ICD-10 Coded): ", out_isva_icd10_agree %>% nrow,
    "\nInSilicoVA ICD-10 Coded (Phy. CGHR-10 Coded): ", out_isva_icd10_cghr10 %>% nrow,
    "\nInSilicoVA ICD-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_isva_icd10_cghr10_agree %>% nrow,
    "\n\nAfter Conversion from ICD-10 to CGHR-10\n---------------------------------------",
    "\nInSilicoVA CGHR-10 Coded (Phy. ICD-10 Coded): ", out_isva_xcghr10 %>% nrow,
    "\nInSilicoVA CGHR-10 Coded (Agree, Phy. ICD-10 Coded): ", out_isva_xcghr10_agree %>% nrow,
    "\nInSilicoVA CGHR-10 Coded (Phy. CGHR-10 Coded): ", out_isva_xcghr10_cghr10 %>% nrow,
    "\nInSilicoVA CGHR-10 Coded (Agree, Phy. CGHR-10 Coded): ", out_isva_xcghr10_cghr10_agree %>% nrow
))
```

### Narrative Counts

Check narrative counts:

```{r}

# Add narr
out_narr <- out %>% left_join(
    df$narrative,
    by = c("rowid" = "rowid"),
    suffix = c("", "")
) %>% filter(
    !is.na(summary)
)

# Display counts
narr_raw <- out_narr %>% nrow
narr_agree <- out_narr %>% filter(
    is_agreed == TRUE
) %>% nrow
narr_icd10 <- out_narr %>% filter(
    !is.na(physician_icd10)
) %>% nrow
narr_cghr10 <- out_narr %>% filter(
    !is.na(physician_cghr10)
) %>% nrow
narr_icd10_agree <- out_narr %>% filter(
    is_agreed == TRUE & !is.na(physician_icd10)
) %>% nrow
narr_cghr10_agree <- out_narr %>% filter(
    is_agreed == TRUE & !is.na(physician_cghr10)
) %>% nrow
cat(paste0(
    "Narratives: ", narr_raw,
    "\nNarratives (Agreed): ", narr_agree,
    "\nNarratives (Phy. ICD-10 Coded): ", narr_icd10,
    "\nNarratives (Phy. CGHR-10 Coded): ", narr_cghr10,
    "\nNarratives (Agreed, Phy. ICD-10 Coded): ", narr_icd10_agree,
    "\nNarratives (Agreed, Phy. CGHR-10 Coded): ", narr_cghr10_agree
))
```

### WHO Formatted Record Counts

Check WHO VA v1.5.1 formatted counts:

```{r}

# Add who
out_who <- out %>% left_join(
    df$who %>% mutate(rowid_who = rowid),
    by = c("rowid" = "rowid"),
    suffix = c("", "")
) %>% filter(!is.na(rowid_who))

# Display counts
who_raw <- out_who %>% nrow
who_agree <- out_who %>% filter(
    is_agreed == TRUE
) %>% nrow
who_icd10 <- out_who %>% filter(
    !is.na(physician_icd10)
) %>% nrow
who_cghr10 <- out_who %>% filter(
    !is.na(physician_cghr10)
) %>% nrow
who_icd10_agree <- out_who %>% filter(
    is_agreed == TRUE & !is.na(physician_icd10)
) %>% nrow
who_cghr10_agree <- out_who %>% filter(
    is_agreed == TRUE & !is.na(physician_cghr10)
) %>% nrow
cat(paste0(
    "WHO Format Records: ", who_raw,
    "\nWHO Format Records (Agreed): ", who_agree,
    "\nWHO Format Records (Phy. ICD-10 Coded): ", narr_icd10,
    "\nWHO Format Records (Phy. CGHR-10 Coded): ", narr_cghr10,
    "\nWHO Format Records (Agreed, Phy. ICD-10 Coded): ", who_icd10_agree,
    "\nWHO Format Records (Agreed, Phy. CGHR-10 Coded): ", who_cghr10_agree
))
```

## Results

Save pre-processed data to `data` folder.

```{r}
write_csv(out, "../data/healsl_rd1to2_cod_v1.csv")
```